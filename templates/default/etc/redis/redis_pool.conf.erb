###
# Generated by Chef for [<%= node[:fqdn] %>]
# Environment: <%= node.chef_environment %>
###

###### BASE ######
daemonize yes
pidfile /var/run/redis/redis-server-<%= @name %>.pid

port <%= @port %>
bind <%= @bind %>
unixsocket /var/run/redis/redis-<%= @name %>.sock
unixsocketperm <%= @unixsocketperm %>

timeout <%= @timeout %>
tcp-keepalive <%= @tcp_keepalive %>

loglevel <%= @loglevel %>
logfile /var/log/redis/redis-server-<%= @name %>.log

databases <%= @databases %>

<% if @snapshotting %>
###### SNAPSHOTTING ######
save 900 1
save 300 10
save 60 10000
<% end %>

stop-writes-on-bgsave-error yes
rdbcompression no
rdbchecksum yes

dbfilename dump-<%= @name %>.rdb
dir <%= @datadir %>

<% unless @requirepass.nil? %>
requirepass <%= @requirepass %>
<% end %>

###### REPLICATION ######
<% unless @slaveof.nil? %>slaveof <%= @slaveof %><% end %>
slave-serve-stale-data yes
slave-read-only <%= @slave_read_only %>

###### LIMITS ######
maxclients 10000
maxmemory-policy <%= @maxmemory_policy %>
maxmemory-samples <%= @maxmemory_samples %>

###### APPENDONLY ######
appendonly yes
appendfilename appendonly-<%= @name %>.aof
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

###### LUA ######
lua-time-limit 5000

###### SLOW LOG ######
slowlog-log-slower-than 10000
slowlog-max-len 128

###### ADVANCED CONFIG ######
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-entries 512
list-max-ziplist-value 64

set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
activerehashing yes

client-output-buffer-limit normal 0 0 0
client-output-buffer-limit slave 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

hz 10
aof-rewrite-incremental-fsync yes
